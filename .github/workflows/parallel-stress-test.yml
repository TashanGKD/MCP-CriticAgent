name: ðŸš€ Parallel MCP Stress Test

on:
  workflow_dispatch:
    inputs:
      test_count:
        description: 'æµ‹è¯•å·¥å…·æ•°é‡'
        required: false
        default: '20'
        type: string
      parallel_jobs:
        description: 'å¹¶è¡Œä»»åŠ¡æ•°'
        required: false
        default: '5'
        type: string
      timeout_seconds:
        description: 'å•å·¥å…·è¶…æ—¶ï¼ˆç§’ï¼‰'
        required: false
        default: '120'
        type: string

jobs:
  # ç”Ÿæˆæµ‹è¯•ç›®æ ‡åˆ—è¡¨
  generate-targets:
    runs-on: ubuntu-latest
    outputs:
      targets: ${{ steps.generate.outputs.targets }}
      total: ${{ steps.generate.outputs.total }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Install UV
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        
    - name: Set up Node.js (for generate-targets)
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        
    - name: Verify runtime environments (generate-targets)
      run: |
        echo "ðŸ” éªŒè¯è¿è¡Œæ—¶çŽ¯å¢ƒ..."
        
        # ä½¿ç”¨ä¸“é—¨çš„éªŒè¯è„šæœ¬
        uv run python scripts/verify_action_runtime.py
        
        if [ $? -eq 0 ]; then
          echo "âœ… è¿è¡Œæ—¶çŽ¯å¢ƒéªŒè¯é€šè¿‡"
        else
          echo "âŒ è¿è¡Œæ—¶çŽ¯å¢ƒéªŒè¯å¤±è´¥"
          exit 1
        fi
      
    - name: Install dependencies
      run: uv sync
    
    - name: Generate test targets
      id: generate
      run: |
        TEST_COUNT="${{ github.event.inputs.test_count || '20' }}"
        
        echo "ï¿½ ç­›é€‰ç®€å•å¯é çš„MCPå·¥å…·è¿›è¡ŒåŽ‹åŠ›æµ‹è¯•..."
        echo "ï¿½ ç›®æ ‡æ•°é‡: $TEST_COUNT"
        
        export TEST_COUNT="$TEST_COUNT"
        
        # ä½¿ç”¨ç®€åŒ–çš„å·¥å…·é€‰æ‹©è„šæœ¬
        OUTPUT=$(uv run python scripts/simple_tool_selector.py)
        
        # æå–targetså’Œtotal
        TARGETS=$(echo "$OUTPUT" | grep "^targets=" | cut -d= -f2-)
        TOTAL=$(echo "$OUTPUT" | grep "^total=" | cut -d= -f2)
        
        echo "targets=$TARGETS" >> $GITHUB_OUTPUT
        echo "total=$TOTAL" >> $GITHUB_OUTPUT
        
        echo "âœ… ç”Ÿæˆäº† $TOTAL ä¸ªå¯é çš„æµ‹è¯•ç›®æ ‡"

  # å¹¶è¡ŒåŽ‹åŠ›æµ‹è¯•
  stress-test:
    needs: generate-targets
    runs-on: ubuntu-latest
    if: needs.generate-targets.outputs.total > 0
    
    env:
      # AIæ¨¡åž‹é…ç½®
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
      OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
      DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
      DASHSCOPE_BASE_URL: ${{ secrets.DASHSCOPE_BASE_URL }}
      DASHSCOPE_MODEL: ${{ secrets.DASHSCOPE_MODEL }}
      
      # Supabaseæ•°æ®åº“é…ç½®
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
    
    strategy:
      matrix:
        target: ${{ fromJson(needs.generate-targets.outputs.targets) }}
      max-parallel: ${{ fromJson(github.event.inputs.parallel_jobs || '5') }}
      fail-fast: false
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        
    - name: Install UV
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        
    - name: Verify runtime environments (stress-test)
      run: |
        echo "ðŸ” éªŒè¯è¿è¡Œæ—¶çŽ¯å¢ƒ..."
        
        # ä½¿ç”¨ä¸“é—¨çš„éªŒè¯è„šæœ¬
        uv run python scripts/verify_action_runtime.py
        
        if [ $? -eq 0 ]; then
          echo "âœ… è¿è¡Œæ—¶çŽ¯å¢ƒéªŒè¯é€šè¿‡"
        else
          echo "âŒ è¿è¡Œæ—¶çŽ¯å¢ƒéªŒè¯å¤±è´¥"
          exit 1
        fi
      
    - name: Install dependencies
      run: uv sync
      
    - name: Complete MCP Tool Testing
      id: test
      run: |
        PACKAGE="${{ matrix.target.package }}"
        NAME="${{ matrix.target.name }}"
        TIMEOUT="${{ github.event.inputs.timeout_seconds || '120' }}"
        
        echo "ðŸ§ª å®Œæ•´æ™ºèƒ½æµ‹è¯•: $NAME ($PACKAGE)"
        echo "ðŸŽ¯ è´¨é‡ç­‰çº§: ${{ matrix.target.quality }}"
        echo "â­ æ˜Ÿæ•°: ${{ matrix.target.stars }}"
        echo "ðŸ¤– æ™ºèƒ½æµ‹è¯•: å¼ºåˆ¶å¯ç”¨"
        echo "ðŸ—„ï¸ æ•°æ®åº“å­˜å‚¨: å¼ºåˆ¶å¯ç”¨"
        
        # æ£€æŸ¥å¿…è¦çš„çŽ¯å¢ƒé…ç½®
        if [ -z "$OPENAI_API_KEY" ] && [ -z "$DASHSCOPE_API_KEY" ]; then
          echo "âŒ é”™è¯¯: æœªé…ç½®AI APIå¯†é’¥ï¼Œæ— æ³•è¿›è¡Œæ™ºèƒ½æµ‹è¯•"
          echo "è¯·é…ç½® OPENAI_API_KEY æˆ– DASHSCOPE_API_KEY"
          exit 1
        fi
        
        if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
          echo "âŒ é”™è¯¯: æœªé…ç½®Supabaseæ•°æ®åº“ï¼Œæ— æ³•å­˜å‚¨æµ‹è¯•ç»“æžœ"
          echo "è¯·é…ç½® SUPABASE_URL å’Œ SUPABASE_SERVICE_ROLE_KEY"
          exit 1
        fi
        
        echo "âœ… AIé…ç½®éªŒè¯é€šè¿‡ï¼Œå¯ç”¨æ™ºèƒ½æµ‹è¯•"
        echo "âœ… æ•°æ®åº“é…ç½®éªŒè¯é€šè¿‡ï¼Œå¯ç”¨ç»“æžœå­˜å‚¨"
        
        # æ‰§è¡Œå®Œæ•´æ™ºèƒ½æµ‹è¯•ï¼ˆå¼ºåˆ¶å¯ç”¨æ‰€æœ‰åŠŸèƒ½ï¼‰
        START_TIME=$(date +%s)
        
        if timeout "${TIMEOUT}s" uv run python -m src.main test-package "$PACKAGE" --timeout "$TIMEOUT" --verbose; then
          STATUS="success"
          echo "âœ… å®Œæ•´æ™ºèƒ½æµ‹è¯•æˆåŠŸ: $NAME"
        else
          STATUS="failed"
          echo "âŒ å®Œæ•´æ™ºèƒ½æµ‹è¯•å¤±è´¥: $NAME"
        fi
        
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        
        echo "status=$STATUS" >> $GITHUB_OUTPUT
        echo "duration=$DURATION" >> $GITHUB_OUTPUT
        echo "package=$PACKAGE" >> $GITHUB_OUTPUT
        echo "name=$NAME" >> $GITHUB_OUTPUT
        echo "quality=${{ matrix.target.quality }}" >> $GITHUB_OUTPUT
        echo "stars=${{ matrix.target.stars }}" >> $GITHUB_OUTPUT
        
        # æ£€æŸ¥ç”Ÿæˆçš„æŠ¥å‘Š
        REPORT_DIR="data/test_results"
        if [ -d "$REPORT_DIR" ]; then
          LATEST_JSON=$(ls -t "$REPORT_DIR"/*.json 2>/dev/null | head -1)
          LATEST_HTML=$(ls -t "$REPORT_DIR"/*.html 2>/dev/null | head -1)
          
          if [ -n "$LATEST_JSON" ]; then
            echo "json_report=$LATEST_JSON" >> $GITHUB_OUTPUT
          fi
          
          if [ -n "$LATEST_HTML" ]; then  
            echo "html_report=$LATEST_HTML" >> $GITHUB_OUTPUT
          fi
        fi
        
        # ä¿å­˜è¯¦ç»†æµ‹è¯•ç»“æžœåˆ°CSV
        echo "$PACKAGE,$NAME,${{ matrix.target.quality }},${{ matrix.target.stars }},$STATUS,$DURATION" > test_result.csv
        
    - name: Upload test result
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-result-${{ strategy.job-index }}
        path: test_result.csv
        retention-days: 7

  # æ±‡æ€»ç»“æžœ
  collect-results:
    needs: [generate-targets, stress-test]
    runs-on: ubuntu-latest
    if: always() && needs.generate-targets.outputs.total > 0
    
    steps:
    - name: Download all test results
      uses: actions/download-artifact@v4
      with:
        pattern: test-result-*
        path: results/
        merge-multiple: true
      
    - name: Generate summary
      run: |
        echo "ðŸ“Š æ±‡æ€»å®Œæ•´åŽ‹åŠ›æµ‹è¯•ç»“æžœ..."
        
        # åˆå¹¶æ‰€æœ‰ç»“æžœæ–‡ä»¶
        if ls results/*.csv 1> /dev/null 2>&1; then
          echo "package,name,quality,stars,status,duration" > all_results.csv
          cat results/*.csv >> all_results.csv
          
          # ç»Ÿè®¡ç»“æžœ
          TOTAL=$(tail -n +2 all_results.csv | wc -l)
          SUCCESS=$(tail -n +2 all_results.csv | grep ",success," | wc -l)
          FAILED=$(tail -n +2 all_results.csv | grep ",failed," | wc -l)
          
          if [ $TOTAL -gt 0 ]; then
            SUCCESS_RATE=$(echo "scale=1; $SUCCESS * 100 / $TOTAL" | bc -l)
          else
            SUCCESS_RATE="0.0"
          fi
          
          # è®¡ç®—å¹³å‡è€—æ—¶
          AVG_DURATION=$(tail -n +2 all_results.csv | cut -d, -f6 | awk '{sum+=$1; count++} END {printf "%.1f", count > 0 ? sum/count : 0}')
          TOTAL_DURATION=$(tail -n +2 all_results.csv | cut -d, -f6 | awk '{sum+=$1} END {printf "%.1f", sum}')
          
          # è´¨é‡åˆ†å¸ƒç»Ÿè®¡
          QUALITY_EXCELLENT=$(tail -n +2 all_results.csv | grep ",ä¼˜è´¨," | wc -l)
          QUALITY_GOOD=$(tail -n +2 all_results.csv | grep ",è‰¯å¥½," | wc -l)
          QUALITY_OTHER=$(($TOTAL - $QUALITY_EXCELLENT - $QUALITY_GOOD))
          
          echo "## ðŸš€ å¹¶è¡Œå®Œæ•´åŽ‹åŠ›æµ‹è¯•ç»“æžœ" > summary.md
          echo "" >> summary.md
          echo "**æµ‹è¯•æ—¶é—´**: $(date)" >> summary.md
          echo "**GitHub Action**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> summary.md
          echo "**æµ‹è¯•æ¨¡å¼**: å®Œæ•´æµ‹è¯•ï¼ˆæ™ºèƒ½åˆ†æž + æ•°æ®åº“å­˜å‚¨ï¼‰" >> summary.md
          echo "" >> summary.md
          
          echo "### ðŸ“Š æµ‹è¯•ç»Ÿè®¡" >> summary.md
          echo "- ðŸŽ¯ æµ‹è¯•æ€»æ•°: $TOTAL" >> summary.md
          echo "- âœ… æˆåŠŸæ•°é‡: $SUCCESS" >> summary.md
          echo "- âŒ å¤±è´¥æ•°é‡: $FAILED" >> summary.md
          echo "- ðŸ“ˆ æˆåŠŸçŽ‡: ${SUCCESS_RATE}%" >> summary.md
          echo "- â±ï¸ æ€»è€—æ—¶: ${TOTAL_DURATION}s" >> summary.md
          echo "- â±ï¸ å¹³å‡è€—æ—¶: ${AVG_DURATION}s" >> summary.md
          echo "" >> summary.md
          
          echo "### ðŸ“Š è´¨é‡åˆ†å¸ƒ" >> summary.md
          echo "- ðŸŒŸ ä¼˜è´¨å·¥å…·: $QUALITY_EXCELLENT" >> summary.md
          echo "- ðŸ‘ è‰¯å¥½å·¥å…·: $QUALITY_GOOD" >> summary.md
          echo "- ðŸ“¦ å…¶ä»–å·¥å…·: $QUALITY_OTHER" >> summary.md
          echo "" >> summary.md
          
          echo "### âš™ï¸ æµ‹è¯•é…ç½®" >> summary.md
          echo "- **æµ‹è¯•ç±»åž‹**: å®Œæ•´æ™ºèƒ½æµ‹è¯•ï¼ˆå¼ºåˆ¶å¯ç”¨ï¼‰" >> summary.md
          echo "- **AIæ™ºèƒ½åˆ†æž**: å¼ºåˆ¶å¯ç”¨" >> summary.md
          echo "- **æ•°æ®åº“å­˜å‚¨**: å¼ºåˆ¶å¯ç”¨" >> summary.md
          echo "- **å·¥å…·è¯„ä¼°**: å¯ç”¨ï¼ˆåŒ…å«å¯æŒç»­æ€§å’Œå—æ¬¢è¿Žç¨‹åº¦è¯„åˆ†ï¼‰" >> summary.md
          echo "- **å¹¶è¡Œä»»åŠ¡æ•°**: ${{ github.event.inputs.parallel_jobs || '5' }}" >> summary.md
          echo "- **å•å·¥å…·è¶…æ—¶**: ${{ github.event.inputs.timeout_seconds || '120' }}s" >> summary.md
          echo "- **æŽ’é™¤ç±»åž‹**: æµè§ˆå™¨è‡ªåŠ¨åŒ–ç›¸å…³å·¥å…·" >> summary.md
          echo "" >> summary.md
          
          # æ˜¾ç¤ºæˆåŠŸçš„ä¼˜è´¨å·¥å…·
          if [ $SUCCESS -gt 0 ]; then
            echo "### âœ… æˆåŠŸæµ‹è¯•çš„å·¥å…·" >> summary.md
            echo "" >> summary.md
            echo "| å·¥å…·åç§° | åŒ…å | è´¨é‡ç­‰çº§ | æ˜Ÿæ•° | è€—æ—¶(s) |" >> summary.md
            echo "|---------|------|----------|------|---------|" >> summary.md
            
            tail -n +2 all_results.csv | grep ",success," | head -10 | while IFS=',' read package name quality stars status duration; do
              echo "| $name | \`$package\` | $quality | $stars | $duration |" >> summary.md
            done
            echo "" >> summary.md
          fi
          
          # æ˜¾ç¤ºå¤±è´¥çš„å·¥å…·
          if [ $FAILED -gt 0 ]; then
            echo "### âŒ å¤±è´¥çš„å·¥å…·" >> summary.md
            echo "" >> summary.md
            echo "| å·¥å…·åç§° | åŒ…å | è´¨é‡ç­‰çº§ | æ˜Ÿæ•° | è€—æ—¶(s) |" >> summary.md
            echo "|---------|------|----------|------|---------|" >> summary.md
            
            tail -n +2 all_results.csv | grep ",failed," | head -5 | while IFS=',' read package name quality stars status duration; do
              echo "| $name | \`$package\` | $quality | $stars | $duration |" >> summary.md
            done
            echo "" >> summary.md
          fi
          
          echo "---" >> summary.md
          echo "**Generated by GitHub Actions** ðŸ¤–" >> summary.md
          
          cat summary.md
          
        else
          echo "âŒ æ²¡æœ‰æ‰¾åˆ°æµ‹è¯•ç»“æžœæ–‡ä»¶"
          echo "## âŒ å®Œæ•´åŽ‹åŠ›æµ‹è¯•å¤±è´¥" > summary.md
          echo "æ²¡æœ‰æ”¶é›†åˆ°ä»»ä½•æµ‹è¯•ç»“æžœ" >> summary.md
        fi
      
    - name: Upload final results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: stress-test-summary
        path: |
          all_results.csv
          summary.md
        retention-days: 30

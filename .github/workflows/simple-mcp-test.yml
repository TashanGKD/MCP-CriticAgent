name: ğŸ§ª Complete MCP Tool Testing

on:
  workflow_dispatch:
    inputs:
      github_url:
        description: 'ğŸ¯ GitHub URL of the MCP tool to test'
        required: true
        default: 'https://github.com/upstash/context7'

jobs:
  test-mcp-tool:
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    
    env:
      # AIæ¨¡å‹é…ç½®
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
      OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
      DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
      DASHSCOPE_BASE_URL: ${{ secrets.DASHSCOPE_BASE_URL }}
      DASHSCOPE_MODEL: ${{ secrets.DASHSCOPE_MODEL }}
      
      # Supabaseæ•°æ®åº“é…ç½®
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        
    - name: Install UV
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.local/bin" >> $GITHUB_PATH
      
    - name: Install dependencies
      run: uv sync
        
    - name: ğŸ§ª Complete MCP Tool Testing
      id: test_mcp
      run: |
        GITHUB_URL="${{ github.event.inputs.github_url }}"
        
        echo "ğŸ¯ å¼€å§‹å®Œæ•´ MCP å·¥å…·æµ‹è¯•"
        echo "ğŸ“ æµ‹è¯•URL: $GITHUB_URL"
        echo "ğŸ¤– æ™ºèƒ½æµ‹è¯•æ¨¡å¼: å·²å¯ç”¨"
        echo "â±ï¸ è¶…æ—¶æ—¶é—´: 600ç§’"
        
        # æ£€æŸ¥AIé…ç½®
        if [ -n "$OPENAI_API_KEY" ] || [ -n "$DASHSCOPE_API_KEY" ]; then
          echo "âœ… AIé…ç½®å·²æ£€æµ‹åˆ°ï¼Œå°†ä½¿ç”¨æ™ºèƒ½æµ‹è¯•æ¨¡å¼"
          USE_SMART="--smart"
        else
          echo "âš ï¸ æœªæ£€æµ‹åˆ°AIé…ç½®ï¼Œä½¿ç”¨åŸºç¡€æµ‹è¯•æ¨¡å¼"
          USE_SMART=""
        fi
        
        # æ£€æŸ¥æ•°æ®åº“é…ç½®
        if [ -n "$SUPABASE_URL" ] && [ -n "$SUPABASE_SERVICE_ROLE_KEY" ]; then
          echo "âœ… Supabaseæ•°æ®åº“é…ç½®å·²æ£€æµ‹åˆ°ï¼Œå°†å¯ç”¨æ•°æ®åº“å­˜å‚¨"
          DATABASE_ENABLED="true"
        else
          echo "âš ï¸ æœªæ£€æµ‹åˆ°Supabaseé…ç½®ï¼Œè·³è¿‡æ•°æ®åº“å­˜å‚¨"
          DATABASE_ENABLED="false"
        fi
        
        # æ‰§è¡Œå®Œæ•´æµ‹è¯•
        uv run python -m src.main test-url "$GITHUB_URL" --timeout 600 --verbose $USE_SMART || {
          echo "âŒ æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­ç”ŸæˆæŠ¥å‘Š"
          exit_code=$?
        }
        
        # æ£€æŸ¥æŠ¥å‘Šç”Ÿæˆ
        REPORT_DIR="data/test_results/reports"
        if [ -d "$REPORT_DIR" ]; then
          LATEST_JSON=$(ls -t "$REPORT_DIR"/*.json 2>/dev/null | head -1)
          LATEST_HTML=$(ls -t "$REPORT_DIR"/*.html 2>/dev/null | head -1)
          
          if [ -n "$LATEST_JSON" ]; then
            echo "json_report=$LATEST_JSON" >> $GITHUB_OUTPUT
            echo "âœ… JSONæŠ¥å‘Š: $LATEST_JSON"
          fi
          
          if [ -n "$LATEST_HTML" ]; then
            echo "html_report=$LATEST_HTML" >> $GITHUB_OUTPUT
            echo "âœ… HTMLæŠ¥å‘Š: $LATEST_HTML"
          fi
        else
          echo "âŒ æœªæ‰¾åˆ°æŠ¥å‘Šç›®å½•"
        fi
        
        # è¾“å‡ºæ•°æ®åº“çŠ¶æ€
        echo "database_enabled=$DATABASE_ENABLED" >> $GITHUB_OUTPUT
      
    - name: ğŸ“Š Database Storage Verification
      if: always() && steps.test_mcp.outputs.database_enabled == 'true'
      id: verify_database
      run: |
        echo "ğŸ” éªŒè¯æ•°æ®åº“å­˜å‚¨ç»“æœ..."
        
        # ä½¿ç”¨Pythonè„šæœ¬éªŒè¯æ•°æ®åº“å­˜å‚¨
        cat > verify_db_storage.py << 'EOF'
        #!/usr/bin/env python3
        import sys
        sys.path.append('src')
        
        try:
            from src.core.supabase_connector import SupabaseConnector
            from datetime import datetime, timedelta
            import json
            
            connector = SupabaseConnector()
            
            # è·å–æœ€è¿‘çš„æµ‹è¯•æŠ¥å‘Š
            recent_cutoff = datetime.now() - timedelta(hours=1)
            
            # æŸ¥è¯¢å„è¡¨çš„è®°å½•æ•°
            tables_info = {}
            
            try:
                # æµ‹è¯•æŠ¥å‘Šè¡¨
                result = connector.client.table('test_reports').select('id', count='exact').gte('created_at', recent_cutoff.isoformat()).execute()
                tables_info['test_reports'] = {'count': len(result.data), 'recent_records': len(result.data)}
                
                # MCPå·¥å…·è¡¨ 
                result = connector.client.table('mcp_tools').select('id', count='exact').execute()
                tables_info['mcp_tools'] = {'count': len(result.data), 'total_tools': len(result.data)}
                
                # æµ‹è¯•æ‰§è¡Œè¡¨
                result = connector.client.table('test_executions').select('id', count='exact').gte('created_at', recent_cutoff.isoformat()).execute()
                tables_info['test_executions'] = {'count': len(result.data), 'recent_records': len(result.data)}
                
                # è´¨é‡æŒ‡æ ‡è¡¨
                result = connector.client.table('quality_metrics').select('id', count='exact').gte('created_at', recent_cutoff.isoformat()).execute()
                tables_info['quality_metrics'] = {'count': len(result.data), 'recent_records': len(result.data)}
                
                # æ€§èƒ½åˆ†æè¡¨
                result = connector.client.table('performance_analysis').select('id', count='exact').gte('created_at', recent_cutoff.isoformat()).execute()
                tables_info['performance_analysis'] = {'count': len(result.data), 'recent_records': len(result.data)}
                
                # éƒ¨ç½²ä¿¡æ¯è¡¨
                result = connector.client.table('deployment_info').select('id', count='exact').gte('created_at', recent_cutoff.isoformat()).execute()
                tables_info['deployment_info'] = {'count': len(result.data), 'recent_records': len(result.data)}
                
                # æµ‹è¯•å…ƒæ•°æ®è¡¨
                result = connector.client.table('test_metadata').select('id', count='exact').gte('created_at', recent_cutoff.isoformat()).execute()
                tables_info['test_metadata'] = {'count': len(result.data), 'recent_records': len(result.data)}
                
                print("âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ")
                print("ğŸ“Š æ•°æ®åº“è¡¨ç»Ÿè®¡:")
                for table, info in tables_info.items():
                    print(f"  ğŸ“‹ {table}: {info.get('recent_records', info['count'])} æ¡æœ€æ–°è®°å½•")
                
                # è¾“å‡ºJSONæ ¼å¼çš„ç»Ÿè®¡ä¿¡æ¯
                with open('db_stats.json', 'w') as f:
                    json.dump(tables_info, f, indent=2)
                
                # æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®è¢«ä¿å­˜
                total_recent = sum(info.get('recent_records', 0) for info in tables_info.values())
                if total_recent > 0:
                    print(f"âœ… æˆåŠŸä¿å­˜ {total_recent} æ¡è®°å½•åˆ°æ•°æ®åº“")
                    sys.exit(0)
                else:
                    print("âš ï¸ æœªæ£€æµ‹åˆ°æ–°çš„æ•°æ®åº“è®°å½•")
                    sys.exit(1)
                    
            except Exception as e:
                print(f"âŒ æŸ¥è¯¢æ•°æ®åº“å¤±è´¥: {e}")
                sys.exit(1)
                
        except Exception as e:
            print(f"âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: {e}")
            sys.exit(1)
        EOF
        
        python verify_db_storage.py || {
          echo "database_verification_failed=true" >> $GITHUB_OUTPUT
          echo "âš ï¸ æ•°æ®åº“éªŒè¯å¤±è´¥ï¼Œä½†ä¸å½±å“æ•´ä½“æµ‹è¯•"
        }
        
        # ä¿å­˜æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯ä¸ºartifact
        if [ -f "db_stats.json" ]; then
          echo "database_stats_available=true" >> $GITHUB_OUTPUT
          echo "âœ… æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯å·²ç”Ÿæˆ"
        fi
      
    - name: Upload Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: mcp-test-reports
        path: |
          data/test_results/
          db_stats.json
        retention-days: 30
    
    - name: Check Pages availability
      if: always()
      id: check_pages
      run: |
        # æ£€æŸ¥æ˜¯å¦å¯ä»¥è®¿é—® Pages API
        if curl -s -H "Authorization: token ${{ github.token }}" \
           "https://api.github.com/repos/${{ github.repository }}" | \
           grep -q '"has_pages": true'; then
          echo "pages_available=true" >> $GITHUB_OUTPUT
          echo "âœ… Pages åŠŸèƒ½å¯ç”¨"
        else
          echo "pages_available=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ Pages åŠŸèƒ½ä¸å¯ç”¨ï¼Œå°†è·³è¿‡ Pages éƒ¨ç½²"
        fi

    - name: Setup Pages
      if: always() && steps.check_pages.outputs.pages_available == 'true'
      uses: actions/configure-pages@v4
    
    - name: Prepare site
      if: always() && steps.check_pages.outputs.pages_available == 'true'
      run: |
        mkdir -p _site
        if [ -n "${{ steps.test_mcp.outputs.html_report }}" ] && [ -f "${{ steps.test_mcp.outputs.html_report }}" ]; then
          cp "${{ steps.test_mcp.outputs.html_report }}" _site/index.html
          echo "âœ… ä½¿ç”¨æµ‹è¯•æŠ¥å‘Šä½œä¸ºä¸»é¡µ"
        else
          echo "<!DOCTYPE html><html><head><meta charset='utf-8'><title>æµ‹è¯•ç»“æœ</title></head><body><h1>MCPå·¥å…·æµ‹è¯•</h1><p>æµ‹è¯•æœªèƒ½ç”ŸæˆHTMLæŠ¥å‘Šï¼Œè¯·æŸ¥çœ‹æ„å»ºäº§ç‰©ä¸­çš„è¯¦ç»†æ—¥å¿—ã€‚</p><p>æ—¶é—´: $(date)</p></body></html>" > _site/index.html
          echo "âš ï¸ ç”Ÿæˆå ä½é¡µé¢"
        fi
        
        # ç¡®ä¿ç›®å½•æƒé™æ­£ç¡®
        chmod -R 755 _site

    - name: Upload Pages artifact
      if: always() && steps.check_pages.outputs.pages_available == 'true'
      uses: actions/upload-pages-artifact@v3
      with:
        path: _site

    - name: Deploy to GitHub Pages
      if: always() && steps.check_pages.outputs.pages_available == 'true'
      id: deployment
      uses: actions/deploy-pages@v4
      continue-on-error: true
      
    - name: Pages deployment status
      if: always()
      run: |
        if [ "${{ steps.deployment.outcome }}" = "success" ]; then
          echo "âœ… GitHub Pages éƒ¨ç½²æˆåŠŸ"
          echo "ğŸ“„ æµ‹è¯•æŠ¥å‘Šåœ°å€: ${{ steps.deployment.outputs.page_url }}"
        else
          echo "âš ï¸ GitHub Pages éƒ¨ç½²å¤±è´¥ï¼Œä½†ä¸å½±å“æµ‹è¯•ç»“æœ"
          echo "ğŸ“¦ è¯·ä»æ„å»ºäº§ç‰©ä¸‹è½½å®Œæ•´æµ‹è¯•æŠ¥å‘Š"
        fi
        
    - name: Create Summary
      if: always()
      run: |
        echo "# ğŸ§ª MCPå·¥å…·å®Œæ•´æµ‹è¯•ç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æµ‹è¯•URL:** \`${{ github.event.inputs.github_url }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**æµ‹è¯•æ¨¡å¼:** å®Œæ•´æµ‹è¯•ï¼ˆå«AIæ™ºèƒ½åˆ†æï¼‰" >> $GITHUB_STEP_SUMMARY
        
        # æ·»åŠ æ•°æ®åº“å­˜å‚¨çŠ¶æ€
        if [ "${{ steps.test_mcp.outputs.database_enabled }}" = "true" ]; then
          echo "**æ•°æ®åº“å­˜å‚¨:** âœ… å·²å¯ç”¨ï¼ˆSupabaseï¼‰" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.verify_database.outputs.database_stats_available }}" = "true" ] && [ -f "db_stats.json" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ğŸ“Š æ•°æ®åº“å­˜å‚¨ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
            
            # ç®€å•æ˜¾ç¤ºæ•°æ®åº“æ–‡ä»¶å†…å®¹
            if command -v jq >/dev/null 2>&1; then
              # å¦‚æœæœ‰jqï¼Œä½¿ç”¨jqè§£æ
              echo "| è¡¨å | æœ€æ–°è®°å½•æ•° |" >> $GITHUB_STEP_SUMMARY
              echo "|------|-----------|" >> $GITHUB_STEP_SUMMARY
              jq -r 'to_entries[] | "| \(.key) | \(.value.recent_records // .value.count) |"' db_stats.json >> $GITHUB_STEP_SUMMARY
            else
              # å¦åˆ™ç®€å•æ˜¾ç¤ºåŸå§‹å†…å®¹
              echo "```json" >> $GITHUB_STEP_SUMMARY
              cat db_stats.json >> $GITHUB_STEP_SUMMARY
              echo "```" >> $GITHUB_STEP_SUMMARY
            fi
            
          elif [ "${{ steps.verify_database.outputs.database_verification_failed }}" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ æ•°æ®åº“éªŒè¯å¤±è´¥ï¼Œå¯èƒ½å­˜åœ¨è¿æ¥é—®é¢˜" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "**æ•°æ®åº“å­˜å‚¨:** âš ï¸ æœªå¯ç”¨ï¼ˆç¼ºå°‘Supabaseé…ç½®ï¼‰" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æ£€æŸ¥ Pages éƒ¨ç½²çŠ¶æ€
        if [ "${{ steps.check_pages.outputs.pages_available }}" = "true" ]; then
          if [ "${{ steps.deployment.outcome }}" = "success" ] && [ -n "${{ steps.deployment.outputs.page_url }}" ]; then
            echo "## ğŸŒ åœ¨çº¿æµ‹è¯•æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
            echo "[ç‚¹å‡»æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š](${{ steps.deployment.outputs.page_url }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ğŸ“„ æµ‹è¯•æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“¦ GitHub Pages éƒ¨ç½²é‡åˆ°é—®é¢˜ï¼Œè¯·ä»ä¸‹æ–¹æ„å»ºäº§ç‰©ä¸­ä¸‹è½½å®Œæ•´æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "## ğŸ“„ æµ‹è¯•æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“¦ GitHub Pages åŠŸèƒ½ä¸å¯ç”¨ï¼Œè¯·ä»ä¸‹æ–¹æ„å»ºäº§ç‰©ä¸­ä¸‹è½½å®Œæ•´æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -n "${{ steps.test_mcp.outputs.json_report }}" ]; then
          echo "## ğŸ“Š æµ‹è¯•ç»“æœæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "- JSONæŠ¥å‘Š: \`${{ steps.test_mcp.outputs.json_report }}\`" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.test_mcp.outputs.html_report }}" ]; then
            echo "- HTMLæŠ¥å‘Š: \`${{ steps.test_mcp.outputs.html_report }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.verify_database.outputs.database_stats_available }}" = "true" ]; then
            echo "- æ•°æ®åº“ç»Ÿè®¡: \`db_stats.json\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âš ï¸ æµ‹è¯•çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "æµ‹è¯•è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—äº†è§£è¯¦æƒ…ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "ğŸ’¾ å®Œæ•´æµ‹è¯•æ•°æ®å·²ä½œä¸ºæ„å»ºäº§ç‰©ä¿å­˜ï¼Œå¯åœ¨Actionsé¡µé¢ä¸‹è½½ã€‚" >> $GITHUB_STEP_SUMMARY

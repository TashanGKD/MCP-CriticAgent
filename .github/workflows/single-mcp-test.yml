name: ðŸ§ª Single MCP Tool Testing

on:
  workflow_dispatch:
    inputs:
      github_url:
        description: 'ðŸŽ¯ GitHub URL of the MCP tool to test'
        required: true
        default: 'https://github.com/upstash/context7'

jobs:
  test-mcp-tool:
    runs-on: ubuntu-latest
    
    env:
      # AIæ¨¡åž‹é…ç½®
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
      OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
      DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
      DASHSCOPE_BASE_URL: ${{ secrets.DASHSCOPE_BASE_URL }}
      DASHSCOPE_MODEL: ${{ secrets.DASHSCOPE_MODEL }}
      
      # Supabaseæ•°æ®åº“é…ç½®
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        
    - name: Install UV
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        
    - name: Verify runtime environments
      run: |
        echo "ðŸ” éªŒè¯è¿è¡Œæ—¶çŽ¯å¢ƒ..."
        
        # ä½¿ç”¨ä¸“é—¨çš„éªŒè¯è„šæœ¬
        uv run python scripts/verify_action_runtime.py
        
        if [ $? -eq 0 ]; then
          echo "âœ… è¿è¡Œæ—¶çŽ¯å¢ƒéªŒè¯é€šè¿‡"
        else
          echo "âŒ è¿è¡Œæ—¶çŽ¯å¢ƒéªŒè¯å¤±è´¥"
          exit 1
        fi
      
    - name: Install dependencies
      run: uv sync
        
    - name: ðŸ§ª Complete MCP Tool Testing
      id: test_mcp
      run: |
        GITHUB_URL="${{ github.event.inputs.github_url }}"
        
        echo "ðŸŽ¯ å¼€å§‹å®Œæ•´ MCP å·¥å…·æµ‹è¯•"
        echo "ðŸ“ æµ‹è¯•URL: $GITHUB_URL"
        echo "â±ï¸ è¶…æ—¶æ—¶é—´: 600ç§’"
        
        # æ£€æŸ¥AIé…ç½®
        if [ -n "$OPENAI_API_KEY" ] || [ -n "$DASHSCOPE_API_KEY" ]; then
          echo "âœ… AIé…ç½®å·²æ£€æµ‹åˆ°ï¼Œå°†ä½¿ç”¨æ™ºèƒ½æµ‹è¯•æ¨¡å¼"
          USE_SMART=""
        else
          echo "âš ï¸ æœªæ£€æµ‹åˆ°AIé…ç½®ï¼Œå°†ç¦ç”¨æ™ºèƒ½æµ‹è¯•"
          USE_SMART="--no-smart"
        fi
        
        # æ£€æŸ¥æ•°æ®åº“é…ç½®
        if [ -n "$SUPABASE_URL" ] && [ -n "$SUPABASE_SERVICE_ROLE_KEY" ]; then
          echo "âœ… Supabaseæ•°æ®åº“é…ç½®å·²æ£€æµ‹åˆ°ï¼Œå°†å¯ç”¨æ•°æ®åº“å­˜å‚¨"
          DATABASE_ENABLED="true"
          USE_DB=""
        else
          echo "âš ï¸ æœªæ£€æµ‹åˆ°Supabaseé…ç½®ï¼Œå°†ç¦ç”¨æ•°æ®åº“å¯¼å‡º"
          DATABASE_ENABLED="false"
          USE_DB="--no-db-export"
        fi
        
        # æ‰§è¡Œå®Œæ•´æµ‹è¯•
        if uv run python -m src.main test-url "$GITHUB_URL" --timeout 600 --verbose $USE_SMART $USE_DB; then
          echo "âœ… æµ‹è¯•æˆåŠŸå®Œæˆ"
          TEST_STATUS="success"
        else
          echo "âŒ æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­ç”ŸæˆæŠ¥å‘Š"
          TEST_STATUS="failed"
        fi
        
        # æ£€æŸ¥æŠ¥å‘Šç”Ÿæˆ
        REPORT_DIR="data/test_results"
        if [ -d "$REPORT_DIR" ]; then
          LATEST_JSON=$(ls -t "$REPORT_DIR"/*.json 2>/dev/null | head -1)
          LATEST_HTML=$(ls -t "$REPORT_DIR"/*.html 2>/dev/null | head -1)
          
          if [ -n "$LATEST_JSON" ]; then
            echo "json_report=$LATEST_JSON" >> $GITHUB_OUTPUT
            echo "âœ… JSONæŠ¥å‘Š: $LATEST_JSON"
          fi
          
          if [ -n "$LATEST_HTML" ]; then
            echo "html_report=$LATEST_HTML" >> $GITHUB_OUTPUT
            echo "âœ… HTMLæŠ¥å‘Š: $LATEST_HTML"
          fi
        fi
        
        # è¾“å‡ºçŠ¶æ€
        echo "test_status=$TEST_STATUS" >> $GITHUB_OUTPUT
        echo "database_enabled=$DATABASE_ENABLED" >> $GITHUB_OUTPUT
      
    - name: ðŸ“Š Database Storage Verification
      if: always() && steps.test_mcp.outputs.database_enabled == 'true'
      id: verify_database
      run: |
        echo "ðŸ” éªŒè¯æ•°æ®åº“å­˜å‚¨ç»“æžœ..."
        
        # ä½¿ç”¨Pythonè„šæœ¬éªŒè¯æ•°æ®åº“å­˜å‚¨
        cat > verify_db_storage.py << 'EOF'
        #!/usr/bin/env python3
        import sys
        import os
        
        # æ£€æŸ¥çŽ¯å¢ƒå˜é‡
        supabase_url = os.getenv('SUPABASE_URL')
        supabase_key = os.getenv('SUPABASE_SERVICE_ROLE_KEY')
        
        if not supabase_url or not supabase_key:
            print("âŒ æ•°æ®åº“é…ç½®ä¸å®Œæ•´")
            sys.exit(1)
        
        try:
            from supabase import create_client
            from datetime import datetime, timedelta
            import json
            
            # åˆ›å»ºSupabaseå®¢æˆ·ç«¯
            client = create_client(supabase_url, supabase_key)
            print("âœ… Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ")
            
            # èŽ·å–æœ€è¿‘5åˆ†é’Ÿçš„æµ‹è¯•è®°å½•
            recent_cutoff = datetime.now() - timedelta(minutes=5)
            
            # æŸ¥è¯¢mcp_test_resultsè¡¨
            result = client.table('mcp_test_results')\
                .select('test_id, test_timestamp, tool_name, tool_author, test_success, deployment_success, communication_success')\
                .gte('test_timestamp', recent_cutoff.isoformat())\
                .order('test_timestamp', desc=True)\
                .execute()
            
            recent_tests = result.data
            total_recent = len(recent_tests)
            
            if total_recent > 0:
                success_count = sum(1 for test in recent_tests if test.get('test_success', False))
                success_rate = (success_count / total_recent) * 100
                
                stats = {
                    'total_recent_tests': total_recent,
                    'successful_tests': success_count,
                    'failed_tests': total_recent - success_count,
                    'success_rate': round(success_rate, 2),
                    'recent_tools': list(set(test.get('tool_name', 'Unknown') for test in recent_tests[:5]))
                }
                
                print(f"ðŸ“Š æœ€è¿‘5åˆ†é’Ÿæµ‹è¯•è®°å½•: {total_recent} æ¡")
                print(f"ðŸ“ˆ æ€»ä½“æˆåŠŸçŽ‡: {success_count}/{total_recent} ({success_rate:.1f}%)")
                
                # ä¿å­˜ç»Ÿè®¡ä¿¡æ¯
                with open('db_stats.json', 'w', encoding='utf-8') as f:
                    json.dump(stats, f, ensure_ascii=False, indent=2)
                
                print("âœ… æ•°æ®åº“éªŒè¯æˆåŠŸ")
            else:
                print("âš ï¸ æœªæ£€æµ‹åˆ°æœ€è¿‘çš„æµ‹è¯•è®°å½•")
                stats = {'total_recent_tests': 0, 'message': 'No recent tests found'}
                
                with open('db_stats.json', 'w', encoding='utf-8') as f:
                    json.dump(stats, f, ensure_ascii=False, indent=2)
                    
        except Exception as e:
            print(f"âŒ æ•°æ®åº“æ“ä½œå¤±è´¥: {e}")
            sys.exit(1)
        EOF
        
        if uv run python verify_db_storage.py; then
          echo "database_stats_available=true" >> $GITHUB_OUTPUT
          echo "âœ… æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯å·²ç”Ÿæˆ"
        else
          echo "database_verification_failed=true" >> $GITHUB_OUTPUT
          echo "âš ï¸ æ•°æ®åº“éªŒè¯å¤±è´¥"
        fi
      
    - name: Upload Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: mcp-test-reports
        path: |
          data/test_results/
          db_stats.json
        retention-days: 30
        
    - name: Create Summary
      if: always()
      run: |
        echo "# ðŸ§ª MCPå·¥å…·æµ‹è¯•ç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æµ‹è¯•URL:** \`${{ github.event.inputs.github_url }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**æµ‹è¯•çŠ¶æ€:** ${{ steps.test_mcp.outputs.test_status || 'æœªçŸ¥' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æ•°æ®åº“å­˜å‚¨çŠ¶æ€
        if [ "${{ steps.test_mcp.outputs.database_enabled }}" = "true" ]; then
          echo "**æ•°æ®åº“å­˜å‚¨:** âœ… å·²å¯ç”¨" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.verify_database.outputs.database_stats_available }}" = "true" ]; then
            echo "**æ•°æ®åº“éªŒè¯:** âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.verify_database.outputs.database_verification_failed }}" = "true" ]; then
            echo "**æ•°æ®åº“éªŒè¯:** âŒ å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "**æ•°æ®åº“å­˜å‚¨:** âš ï¸ æœªå¯ç”¨" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“„ æµ‹è¯•æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        
        if [ -n "${{ steps.test_mcp.outputs.json_report }}" ]; then
          echo "- JSONæŠ¥å‘Š: \`${{ steps.test_mcp.outputs.json_report }}\`" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ steps.test_mcp.outputs.html_report }}" ]; then
            echo "- HTMLæŠ¥å‘Š: \`${{ steps.test_mcp.outputs.html_report }}\`" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âš ï¸ æœªç”Ÿæˆæµ‹è¯•æŠ¥å‘Šï¼Œè¯·æŸ¥çœ‹Actionsæ—¥å¿—äº†è§£è¯¦æƒ…ã€‚" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“¦ å®Œæ•´æµ‹è¯•æ•°æ®å·²ä½œä¸ºæž„å»ºäº§ç‰©ä¿å­˜ï¼Œå¯åœ¨Actionsé¡µé¢ä¸‹è½½ã€‚" >> $GITHUB_STEP_SUMMARY
